#================================================================================#
# This makefile created by G. Vijayakumar on 28-July-2016                        #
# adapted from FAST (B. Jonkman on 28-July-2016.                                 #
# (c) 2016 National Renewable Energy Laboratory                                  #
#                                                                                #
# This makefile has been tested on Linux x64 with gfortran-4.8.                  #
#                                                                                #
# It was designed to be used with FAST_Prog.c for a C driver program for FAST    #
#================================================================================#

   # 32-bit or 64-bit?
#BITS = 32
BITS = 64

   # Location of source files for the DLL.
   # You may need to change these for your DLL.

SOURCE_DIR  = ../Source
SOURCE_FILES = FAST_Prog.c FAST_cInterface.c FAST_Prog_cInterface.c SC.c


   # Name of compiler to use and flags to use.
CC      = mpicc
CPP     = mpic++
CFLAGS  = -O0 -g -DHAVE_MPI

   # Destination and RootName for executable


YAMLCPPLIB_DIR = ../Source/dependencies/yaml-cpp/lib/
FASTLIB_DIR = ../bin
DEST_DIR    = ../bin

   #==========================================================#
   # You should not need to change anything beyond this point #
   #==========================================================#

#Currently only supports Linux
# System-specific settings.
DEL_CMD   = rm -f
EXE_EXT   = _glin$(BITS)
INTER_DIR = Obj_lin$(BITS)
MD_CMD    = @mkdir -p
OBJ_EXT   = .o
PATH_SEP  = /
SYS_FILE  = SysGnuLinux

UNAME := $(shell uname -s)

CFLAGS     := $(CFLAGS) -fPIC -fpermissive -std=c++11
LDFLAGS    = -fPIC -L$(FASTLIB_DIR) -L$(YAMLCPPLIB_DIR) -lFAST_glin$(BITS) -lmap-1.20.10 -lyaml-cpp -ldl

_ALL_OBJS  = $(SOURCE_FILE:.c=$(OBJ_EXT))
ALL_OBJS   = $(patsubst %,$(INTER_DIR)/%,$(_ALL_OBJS))

# Rule to do everything.

all:     default
cppOnly: $(INTER_DIR) $(DEST_DIR)/FAST_cDriverProg_cInterface$(EXE_EXT)  $(DEST_DIR)/libScontroller.so
default:  $(INTER_DIR) $(DEST_DIR)/FAST_cDriverProg$(EXE_EXT) $(DEST_DIR)/FAST_cDriverProg_cInterface$(EXE_EXT)

   # General rules for compliling the files.

$(INTER_DIR)/FAST_Prog.o: $(SOURCE_DIR)/FAST_Prog.c $(SOURCE_DIR)/dependencies/OpenFOAM/OpenFOAM_Types.h $(SOURCE_DIR)/dependencies/SuperController/SuperController_Types.h
	$(CC)  $(CFLAGS) -c $< -I$(SOURCE_DIR)/dependencies/OpenFOAM/ -I$(SOURCE_DIR)/dependencies/SuperController -o $@ 

$(INTER_DIR)/FAST_cInterface.o: $(SOURCE_DIR)/FAST_cInterface.c $(SOURCE_DIR)/FAST_cInterface.h $(SOURCE_DIR)/dependencies/OpenFOAM/OpenFOAM_Types.h $(SOURCE_DIR)/dependencies/SuperController/SuperController_Types.h
	$(CPP)  $(CFLAGS) -c $< -I$(SOURCE_DIR)/dependencies/OpenFOAM/ -I$(SOURCE_DIR)/dependencies/SuperController -I$(SOURCE_DIR)/dependencies/yaml-cpp/include/ -o $@ 

$(INTER_DIR)/FAST_Prog_cInterface.o: $(SOURCE_DIR)/FAST_Prog_cInterface.c $(SOURCE_DIR)/FAST_cInterface.h $(INTER_DIR)/FAST_cInterface.o $(SOURCE_DIR)/dependencies/OpenFOAM/OpenFOAM_Types.h $(SOURCE_DIR)/dependencies/SuperController/SuperController_Types.h
	$(CPP)  $(CFLAGS) -c $< -I$(SOURCE_DIR) -I$(SOURCE_DIR)/dependencies/OpenFOAM/ -I$(SOURCE_DIR)/dependencies/SuperController -I$(SOURCE_DIR)/dependencies/yaml-cpp/include/ -o $@

   # Make sure the destination directory for the intermediate files exist.

$(INTER_DIR):
	$(MD_CMD) $(INTER_DIR)

   # For linking 

$(DEST_DIR)/FAST_cDriverProg$(EXE_EXT): $(INTER_DIR)/FAST_Prog.o
	$(CC) $(CFLAGS) -o $(DEST_DIR)/FAST_cDriverProg$(EXE_EXT) \
	$(INTER_DIR)/FAST_Prog.o $(LDFLAGS)

$(DEST_DIR)/FAST_cDriverProg_cInterface$(EXE_EXT): $(INTER_DIR)/FAST_Prog_cInterface.o $(INTER_DIR)/FAST_cInterface.o
	$(CPP) $(CFLAGS) -o $(DEST_DIR)/FAST_cDriverProg_cInterface$(EXE_EXT) \
	$(INTER_DIR)/FAST_Prog_cInterface.o $(INTER_DIR)/FAST_cInterface.o $(LDFLAGS)

$(DEST_DIR)/libScontroller.so: $(SOURCE_DIR)/SC.c
	$(CPP) -fPIC -shared -I$(SOURCE_DIR)/dependencies/SuperController -o $(DEST_DIR)/libScontroller.so \
        $(SOURCE_DIR)/SC.c

   # Cleanup afterwards.

clean:
	$(DEL_CMD) $(INTER_DIR)$(PATH_SEP)FAST_Prog$(OBJ_EXT) $(INTER_DIR)$(PATH_SEP)FAST_cInterface$(OBJ_EXT) $(INTER_DIR)$(PATH_SEP)FAST_Prog_cInterface$(OBJ_EXT)
#	$(DEL_CMD) $(INTER_DIR)$(PATH_SEP)*$(OBJ_EXT) $(DEST_DIR)/$(OUTPUT_NAME)$(EXE_EXT)


